unit mi.rtl.objects.methods.pageproducer;
{:< - A unit **@name** implementa as propriedade e m√©todos para produzir
      p√°gina html, semelhante a unit HTTPProd do Delphi.

  - **NOTAS**
    -

  - **VERS√ÉO**
    - Alpha - 0.7.1.621

  - **HIST√ìRICO**
    - Criado por: Paulo S√©rgio da Silva Pacheco e-mail: paulosspacheco@@yahoo.com.br
      - **23/07/2023**
        - 08:12 a 12:00: Criar a unit **@name**

      - **24/07/2023**
        - 08:45 a 12:00: Documento da unit
        - 14:00 a 17:30: Documento da unit

      - **25/07/2023**
        - 08:15 a 12:00: Documento da unit
        - 13:30 a 17:30: Documento da unit


  - **C√ìDIGO FONTE**:
    - @html(<a href="../units/mi.rtl.objects.pas">mi.rtl.objects.pas</a>)

}

{$IFDEF FPC}
  {$MODE Delphi} {$H+}
{$ENDIF}

interface

uses
  Classes, SysUtils,FPTemplate
  ,mi.rtl.Objects.Methods
  ,mi.rtl.Objects.Methods.Paramexecucao.Application

  ;



Type

  { TBasePageProducer }

  TBasePageProducer = class(TObjectsMethods)
    public

      Type

        {: O tipo **@name** usado em THTMLTagEven indicando o tipo de tag.
           - **NOTAS:**
             -  
        }
        TTag = (Tgcustom, tgLink, tgImage, tgTable, tgImageMap, tgObject, tgEmbed);

      Type
        {: O tipo **@name** usado para preencher modelos pre-fabricados de c√≥digos para preencher com var√°veis.}
        THTMLTagEvent = TReplaceTagEvent;
        //THTMLTagEvent = procedure (Sender: TObject; Tag: TTag; const TagString: string;  TagParams: TStrings; var ReplaceText: string) of object;

      public constructor create(aOwner:TComponent);override;
      public destructor destroy; override;

      {$REGION '--->Constru√ß√£o da propriedade Alias'}
        Private  _Alias    : AnsiString;
        Published  Property Alias : AnsiString Read _Alias Write _Alias;
      {$ENDREGION}

      protected Function GetHTMLContent : AnsiString;Virtual;
      Public Property HTMLContent : AnsiString Read GetHTMLContent;// write SetHTMLContent;

      {$REGION '---> Constru√ß√£o da propriedade OnHTMLTag'}
        Private  var _OnHTMLTag    : Boolean;
        Private Procedure SetOnHTMLTag(const aOnHTMLTag    : Boolean);
        Public Property OnHTMLTag  : Boolean Read _OnHTMLTag Write SetOnHTMLTag;
      {$ENDREGION}

      {$REGION '---> Constru√ß√£o da propriedade HTMLDoc'}
        private var _HTMLDoc: TStrings;
        Private Procedure SetHTMLDoc(Const aHTMLDoc: tStrings);
        Private Function GetHTMLDoc: tStrings;
        Public Property HTMLDoc  : tStrings Read GetHTMLDoc Write SetHTMLDoc;
      {$ENDREGION}

      {$REGION '---> Constru√ß√£o da propriedade HTMLFile'}
        Protected Procedure SetHTMLFile(Const aHTMLFile: TFileName );Overload;Virtual;
        Protected Private Function GetHTMLFile : TFileName;Virtual;
        Public Property HTMLFile : TFileName read GetHTMLFile Write SetHTMLFile;
        Public Procedure SetHTMLFile();Overload;Virtual;//< Deve se definido em cada objeto herdado.
      {$ENDREGION}

        Public Function  SaveHTMLContentToFile(FileNameDest:AnsiString):Integer;overload ;Virtual;
        Public Function  SaveHTMLContentToFile:Integer;overload ;Virtual;

      {$REGION '---> Constru√ß√£o da propriedade FPTemplate'}
        Private _FPTemplate : TFPTemplate;
        Public Property FPTemplate : TFPTemplate read _FPTemplate write _FPTemplate;
      {$ENDREGION}

      {: O m√©todo **@name** √© executado por - *@link(DoReplaceTag)*.

         - **DESCRI√á√ÉO**

           - O manipulador de eventos *DoOnHTMLTag* deve retornar os comandos HTML
             convertidos no par√¢metro *ReplaceText*. O valor retornado pode conter tags
             HTML transparentes para outro produtor de p√°gina converter.
             - Por exemplo:
               - Um produtor de p√°gina pode ter um modelo que representa o formato
                 do HTTP final da resposta. Ele pode ler a solicita√ß√£o HTTP e, para cada
                 se√ß√£o da solicita√ß√£o, montar um conjunto de Tags transparentes
                 em HTML com par√¢metros baseados na solicita√ß√£o.

               - Outro produtor de p√°gina pode pegar o conte√∫do do produtor da
                 primeira p√°gina e interpret√°-los os par√¢metros.


         - **PAR√ÇMETROS**
           - **TagParams**:*TStringList*
             - O par√¢metro *TagParams* fornece a parte do par√¢metro da tag do template.
               - Cada string no objeto *tStrings* tem a forma *ParamName*=*Value*.
               - Use as propriedades *Names* e *Values* do objeto *tStrings* para analisar esses par√¢metros.

           - **TagString**:String*
             - Nome da tag no template.
               - Exemplo de template para preencher a data e hora no formato: *MM/DD hh:mm:ss*:

                   ```pascal

                       <html lang="pt-BR">

                       <bodY>
                         DateTime in format "MM/DD hh:mm:ss":
                         <b>
                           <!--# DATETIME [-FORMAT=MM/DD hh:mm:ss-] #-->
                         </b>
                        </body>
                       </html>
                   ```

                 - **NOTAS**
                   - **TagString** : *DATETIME*:

                     ```pascal

                        <!--# DATETIME #-->

                     ```

                   - **TagParams**: *FORMAT*
                     ```pascal

                        [- FORMAT=MM/DD hh:mm:ss -]

                     ```

           - **ReplaceText** : *String*
               - Retorna o template preenchido para a classe que o executou.
                 - Exemplo:

                   ```pascal

                       procedure TFPWebModule2.func1callReplaceTag(Sender: TObject; const TagString:                      String; TagParams: TStringList; Out ReplaceText: String);
                       begin
                         if AnsiCompareText(TagString, 'DATETIME') = 0 then
                         begin
                           ReplaceText := FormatDateTime(TagParams.Values['FORMAT'], Now);
                         end;
                       end;

                   ```

           - **aTag** : *TTag*
             - Usado para executar m√©todos produtores de c√≥digo baseado em templates.
               - *aTag* = *tgCustom*:
                 - Executa o m√©todo virtual @link(DoOnHTMLTag_tgCustom):
                   - O m√©todo @link(DoOnHTMLTag_tgCustom) deve processar os par√¢metros *Name*=*Values* de
                     **TagParams** definido pelo m√©todo que o executadou. @link(DoOnHTMLTag_tgCustom Veja mais):
                   - **Exemplo**:
                     -

               - *atag* = *tgTable*
                   - Executa a procedure virtual @link(DoOnHTMLTag_tgTable) para que seja preenchido
                     os seguintes par√¢metros:
                     - HEADER
                     - ONEROW
                     - NOTFOUND
                     - FOOTER


                 - Os m√©todos que ser√£o executados depende do par√¢metro **aTag**:
                   - **aTag** = *tgLink*
                     - DoOnHTMLTag_tgLink
                       - Par√¢metros esperados:
                         - href
                         - name
                         - type
                         - label
                         - Exemplo:

                           ```pascal

                              [- <a href="#link" name="name" type="text/html">label=Descri√ß√£o do Link</a> -]

                           ```
                   - **aTag** = *tgImage*
                     - DoOnHTMLTag_tgImage
                       - Par√¢metros esperados:
                         - src=Nome do arquivo de imagem
                         - alt = Mensagem a ser mostrada caso a imagem n√£o exista.
                         - title = Help
                         - Exemplo:

                           ```pascal

                              <img src="images/image01.jpg"
                                   alt="Imagem de v√°rios reposit√≥rios e o servidor"
                                   title="Esta imagem mostra de forma visual como funciona as c√≥pias dos arquivos.">

                           ```

                   - **atag** = *tgImageMap*
                     - DoOnHTMLTag_tgImageMap

                   - **atag** = *tgObject*
                     - DoOnHTMLTag_tgObject

                   - **atag** = *tgEmbed*
                     - DoOnHTMLTag_tgEmbed

                   - **atag** = *tgCustom*
                     - DoOnHTMLTag_tgCustom

         - **EXEMPLO**

             ```pascal

               <html lang="pt-BR">

               <bodY>
                 DateTime in format "MM/DD hh:mm:ss":
                 <b>
                   <!--# DATETIME [-FORMAT=MM/DD hh:mm:ss-] #-->
                 </b>

                 <br>

                 List of records:
                 <table class="beautify1">
                   <tr class="beautify2">
                     <td class="beautify3">

                       <!--# tgTable

                         [-Header=
                           <table bordercolorlight="#6699CC" bordercolordark="#E1E1E1" class="Label">
                             <tr class="Label" align=center bgcolor="#6699CC">
                               <th>
                                 <font color="white">~Column1</font>
                               </th>
                               <th>
                                 <font color="white">~Column2</font>
                               </th>
                             </tr>
                         -]

                         [- OneRow =
                           <tr bgcolor="#F2F2F2" class="Label3" align="center">
                             <td>~Column1Value</td>
                             <td>~Column2value</td>
                           </tr>
                         -]
                         .
                         .snip, and so on more parameters if needed
                         .
                         [- NotFound=
                           <tr class="Error">
                             <td>There are no entries found.</td>
                           </tr>
                         -]

                         [-Footer=
                           </table>
                         -]

                       #-->

                     </td>
                   </tr>
                 </table>
                </body>

               </html>

             ```

         - @url("#" üîù)

      }
      Public  procedure DoOnHTMLTag (Sender : TObject;
                                     aTag :TTag;
                                     Const TagString : String;
                                     TagParams:TStringList;
                                     Out ReplaceText : String);

      {: O m√©todo @name √© passado para *@link(FPTemplate.OnReplaceTag)* com objetivo de executar
         os produtor c√≥digo da classe.

         - NOTA
           - O m√©todo FPTemplate.OnReplaceTag pode ser definido para que possa customizar
             essa classe

      }
      private procedure DoReplaceTag_Default(Sender: TObject;  const TagString: String;TagParams: TStringList; Out ReplaceText: String);

  end;

Resourcestring

  {: O recurso **@name** deve ser usado nos templates para o componente *TBasePageProducer*.

     - PAR√ÇMETROS
       - %s      = Alias ou Nome do template;
       - ~url    = Endere√ßo do link
       - ~target = Destino onde a p√°gina deve ser aberta, se vazio abre na aba atual.
       - ~title  = Documenta√ß√£o do link
       - ~text   = Descri√ß√£o do link

     - Exemplo de uso:

       ```pascal



       ```
  }
  Template_html_tglink = '<!--# tgLink [- %s=[a href="~url" target="~target" title="~title"] ~text [/a]  -] #-->';


procedure register;

implementation

procedure register;
begin

end;


procedure TBasePageProducer.SetOnHTMLTag(const aOnHTMLTag: Boolean);
Begin
   If aOnHTMLTag
   Then with TObjectsMethods do
        Begin
          //se tiver assinalado deve ser descartado
          If isValidPtr(_FPTemplate)
          Then Discard(TObject(_FPTemplate));

//          Method.code := self.MethodAddress('DoOnHTMLTag');
{          If Method.code <> nil
          Then Begin}
                 If TFPTemplate=nil
                 Then Begin
                        FPTemplate := TFPTemplate.Create;
                        //FPTemplate.StripParamQuotes := false; N√£o encontrei no fptemplate
                      End;
//                 Method.Data  := self;
                 FPTemplate.OnReplaceTag := DoReplaceTag_Default;//DoOnHTMLTagEvent;
                 _OnHTMLTag := True;
{               End
          Else _OnHTMLTag := false;}
        End
   Else Begin
          TObjectsMethods.Discard(TObject(_FPTemplate));
          _OnHTMLTag := false;
        End;
End;

procedure TBasePageProducer.SetHTMLFile(const aHTMLFile: TFileName);

Begin
  If (aHTMLFile='') or (TObjectsMethods.FileExists(aHTMLFile))
  Then Begin
         OnHTMLTag := true;
         If OnHTMLTag
         Then begin
                 //function ExtractRelativePath(const BaseName, DestName: string): string; overload;
                 FPTemplate.FileName:= aHTMLFile
              end;
       End
  Else Begin
         OnHTMLTag := False;
         TObjectsMethods.TaStatus  := TObjectsMethods.ArquivoNaoEncontrado2;
       end;
end;

function TBasePageProducer.GetHTMLFile: TFileName;
Begin
  If OnHTMLTag
  Then Result := FPTemplate.FileName
  Else Result := '';
end;

function TBasePageProducer.SaveHTMLContentToFile(FileNameDest: AnsiString): Integer;
  Var
    PathDest : AnsiString;
    F        : Text;

begin
  Result := -1;
  If OnHTMLTag
  Then with TObjectsMethods do
       Begin
         Try  //Except
           PathDest := ExtractFileDir(FileNameDest);

           if Not DirectoryExists(PathDest)
           Then ok := CreateDir(PathDest)
           Else ok := true;

           If ok
           Then Begin
                  AssignFile(F,FileNameDest);

                  {$I+}
                  rewrite(f);
                  {$I-}

                  Result := IoResult ;

                  If Result = 0
                  Then Begin
                         {$I+}
                         write(F,self.HTMLContent);
                         {$I-}
                         Result := IoResult;

                         close(f) ;
                       End;

                End;
         Except
           if Result = 0
           then Result :=   Erro_Excecao_inesperada ;
           Raise
         end;
       End;
end;

function TBasePageProducer.SaveHTMLContentToFile: Integer;
Begin
  Result := -1;
End;

procedure TBasePageProducer.SetHTMLDoc(const aHTMLDoc: tStrings);
Begin
  _HTMLDoc := aHTMLDoc;

  OnHTMLTag := true;
  If OnHTMLTag
  Then begin
         {O componente fpTemplate n√£o existe op√ß√£o de template em mem√≥ria.
          Para implementar HTMLDoc √© necess√°rio criar arquivo tempor√°rio.
         }
         //FPTemplate.HTMLDoc := aHTMLDoc;

       end;

end;

procedure TBasePageProducer.SetHTMLFile;
begin


end;

function TBasePageProducer.GetHTMLDoc: tStrings;
Begin
  {O componente fpTemplate n√£o existe op√ß√£o de template em mem√≥ria.
   Para implementar HTMLDoc √© necess√°rio criar arquivo tempor√°rio.
  }
  //If OnHTMLTag
  //Then Result := TFPTemplate.HTMLDoc
  //Else Result := nil;
end;

constructor TBasePageProducer.create(aOwner:TComponent);
begin
  inherited create(aOwner);

  _FPTemplate := TFPTemplate.Create;
  with FPTemplate do
  begin
    AllowTagParams := true;
    StartDelimiter := '<!--#';
    EndDelimiter := '#-->';
    OnReplaceTag := DoReplaceTag;
  end;
end;

destructor TBasePageProducer.destroy;
begin
  freeAndnil(_FPTemplate);
  inherited destroy;
end;

function TBasePageProducer.GetHTMLContent: AnsiString;
{< NortSoft
   Retorna O c√≥digo HTML implementados em:
     1 - TvDialogs.TButton      Retorna o c√≥digo Html associado ao bot√£o
     2 - ViEditor.TDmxEditor    Retorna o c√≥digo Html associado ao Dmx
     3 - ViEditor.TLIsDialog   Retorna a lista html
     4 - tvDMXBUF.TDmxEditBuf;  Retorna o formul√°rio em forma de gride
     5 - View.TWindow           Retorna todos os c√≥digos html dentro da windows
     6 - TvDialogs.TDialog      Retorna o formul√°rio completo <html lang="pt-BR"><head> </head> <bodY>  </body></html
}
Begin
  If OnHTMLTag
  Then Result := FPTemplate.GetContent
  Else Result := '';
end;


procedure TBasePageProducer.DoOnHTMLTag(Sender: TObject;  aTag :TTag; const TagString: String; TagParams: TStringList; out ReplaceText: String);

{ Original:
   The TagString parameter is the tag name of the HTML-transparent tag.
   If the Tag parameter is tgCustom, TagString should be used to determine what conversion to perform.
   The TagParams parameter gives the parameter portion of the HTML-transparent tag.
   Each string in the tStrings object has the form ParamName=Value.
   Use the Names and Values properties of the tStrings object to parse these parameters.

   The DoOnHTMLTag event handler should return the converted HTML commands in the ReplaceText parameter.

   The returned value can contain HTML-transparent tags for another page producer to convert.

   For example, one page producer might have a template that represents the format of the final HTTP
   response. It could read the HTTP request and for each section in the request assemble a set of
   HTML-transparent tags with parameters based on the request.
   Another page producer might take the content of the first page producer, and interpret those
   parameters.
}


{

 Evento OnHTMLTag
     O componente TFPTemplate apresenta apenas um evento: o evento OnHTMLTag.
     √â nesse evento que √© definido o c√≥digo HTML usado para substituir os tags
     transparentes lidos pelo TFPTemplate.
     O evento √© chamado uma vez para cada tag transparente encontrado.

     OnHTMLTag recebe v√°rios par√¢metros importantes. Veja quais s√£o, no seguinte c√≥digo b√°sico do evento.

     Procedure TwebModule1.TFPTemplate1HTMLTag(Sender: Tobject; Tag: Ttag; const      TagString:String; TagParams: Tstring; var ReplaceText: String);
     Begin

     end;

     O par√¢metro TagString recebe o nome do tag transparente. Para o tag transparente <#data> por exemplo,
     TagString seria ‚Äúdata‚Äù. O texto no par√¢metro TagString deve ser verificado pelo programa, para determinar
     o c√≥digo HTML a ser usado para a substitui√ß√£o do tag transparente.

     O par√¢metro ReplaceText √© passado por referencia para o c√≥digo do evento OnHTMLTag. √â inicialmente um
     String vazio. Dentro do c√≥digo para evento, ReplaceText deve receber um String com o c√≥digo HTML
     usado para substituir o tag transparente.

     Em TagParams s√£o armazenados os par√¢metros do tag transparente. Os par√¢metros s√£o armazenados na forma
     Nome=Valor e podem ser acessados usando as propriedades Names e Values. Por exemplo, para o tag:

     <#calend√°rio ano=2001 m√™s=12>

     Ter√≠amos o seguinte: TagParams.Names[0] = ‚Äòm√™s‚Äô
     TagParams.Names[1] = ‚Äòano‚Äô
     TagParams.Values[‚Äòano‚Äô] = ‚Äò1999‚Äô
     TagParams.Values[‚Äòm√™s‚Äô] = ‚Äò12‚Äô

     Caso o tag transparente n√£o apresente par√¢metros, os valores retornados para Values e Names
     ser√£o tStrings vazios.
}
Begin
  Case aTag of
    tgCustom   : DoOnHTMLTag_tgCustom  (Sender,TagString,TagParams, ReplaceText);
    tgLink     : DoOnHTMLTag_tgLink    (Sender,TagString,TagParams, ReplaceText);
    tgImage    : DoOnHTMLTag_tgImage   (Sender,TagString,TagParams, ReplaceText);
    tgTable    : DoOnHTMLTag_tgTable   (Sender,TagString,TagParams, ReplaceText);
    tgImageMap : DoOnHTMLTag_tgImageMap(Sender,TagString,TagParams, ReplaceText);
    tgObject   : DoOnHTMLTag_tgObject  (Sender,TagString,TagParams, ReplaceText);
    tgEmbed    : DoOnHTMLTag_tgEmbed   (Sender,TagString,TagParams, ReplaceText)
    else         DoReplaceTag(Sender,TagString,TagParams, ReplaceText)
  End;
end;

procedure TBasePageProducer.DoReplaceTag_Default(Sender: TObject; const TagString: String; TagParams: TStringList; out ReplaceText: String);
begin

  if AnsiCompareText(TagString, 'tgCustom') = 0
  then DoOnHTMLTag_tgCustom(Sender,TagString,TagParams,ReplaceText)
  else  if AnsiCompareText(TagString, 'tgLink') = 0
        then DoOnHTMLTag_tgLink(Sender,TagString,TagParams,ReplaceText)
        else if AnsiCompareText(TagString, 'tgImage') = 0
             then DoOnHTMLTag_tgImage(Sender,TagString,TagParams,ReplaceText)
             else if AnsiCompareText(TagString, 'tgTable') = 0
                  then DoOnHTMLTag_tgTable(Sender,TagString,TagParams,ReplaceText)
                  else if AnsiCompareText(TagString, 'tgImageMap') = 0
                       then DoOnHTMLTag_tgImageMap(Sender,TagString,TagParams,ReplaceText)
                       else if AnsiCompareText(TagString, 'tgObject') = 0
                            then DoOnHTMLTag_tgImageMap(Sender,TagString,TagParams,ReplaceText)
                            else if AnsiCompareText(TagString, 'tgEmbed') = 0
                                 then DoOnHTMLTag_tgEmbed(Sender,TagString,TagParams,ReplaceText)
                                 else DoReplaceTag(Sender,TagString,TagParams,ReplaceText);
end;


end.

